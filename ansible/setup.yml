---
- name: Nivel 1 - Preparación de todos los nodos (LXC Fix)
  hosts: mis_nodos
  gather_facts: yes
  become: true
  tasks:
    - name: Actualizar repositorios
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Instalar Dependencias
      apt:
        name: [curl, htop, nfs-common, open-iscsi]
        state: present

    - name: Fix /dev/kmsg para entornos LXC
      shell: |
        if [ ! -e /dev/kmsg ]; then
          ln -s /dev/console /dev/kmsg
        fi
      args:
        creates: /dev/kmsg

    - name: Engañar a modprobe (LXC Kernel Fix)
      shell: |
        ln -sf /bin/true /usr/local/bin/modprobe
        ln -sf /bin/true /sbin/modprobe
      args:
        creates: /usr/local/bin/modprobe

- name: Nivel 2 - Configurar K3s Master (nodo4)
  hosts: k3s_server
  become: true
  tasks:
    - name: Fix Mount Flags Master
      shell: mount --make-rshared /
      ignore_errors: yes

    - name: Instalar K3s Server
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server \
        --protect-kernel-defaults=false \
        --disable-agent" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Obtener el Token del Cluster
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: node_token

- name: Nivel 3 - Configurar K3s Workers (nodo1, nodo2, nodo3)
  hosts: k3s_agents
  become: true
  serial: 1
  vars:
    master_ip: "{{ hostvars[groups['k3s_server'][0]]['ansible_host'] }}"
  tasks:
    - name: Esperar a que el API Server del Master esté listo
      wait_for:
        host: "{{ master_ip }}"
        port: 6443
        timeout: 180

    - name: Fix LXC - Montajes compartidos y Sysfs
      shell: |
        mount --make-rshared /
        mount -o remount,rw /sys
      ignore_errors: yes

    - name: Engañar a modprobe (LXC Fix)
      shell: |
        ln -sf /bin/true /usr/local/bin/modprobe
        ln -sf /bin/true /sbin/modprobe
      args:
        creates: /usr/local/bin/modprobe

    - name: Crear directorios de K3s
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      with_items:
        - /var/lib/rancher/k3s/agent
        - /var/lib/rancher/k3s/data
        - /etc/rancher/k3s

    - name: Instalar K3s Agent (Sin auto-start para evitar error de rc 1)
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_ENABLE=true INSTALL_K3S_SKIP_START=true \
        K3S_URL=https://{{ master_ip }}:6443 \
        K3S_TOKEN={{ hostvars[groups['k3s_server'][0]]['node_token']['stdout'] }} \
        INSTALL_K3S_EXEC="agent \
        --protect-kernel-defaults=false \
        --kube-proxy-arg=conntrack-max-per-core=0 \
        --kubelet-arg=feature-gates=KubeletInUserNamespace=true" sh -

    - name: Configurar servicio para ignorar fallos de modprobe
      lineinfile:
        path: /etc/systemd/system/k3s-agent.service
        regexp: '^ExecStartPre='
        line: 'ExecStartPre=/bin/true'
        insertbefore: '^ExecStart='

    - name: Iniciar K3s Agent manualmente
      systemd:
        name: k3s-agent
        state: started
        enabled: yes
        daemon_reload: yes
      register: agent_start
      until: agent_start is succeeded
      retries: 5
      delay: 10

- name: Nivel 4 - Instalar Almacenamiento Persistente (NFS Provisioner)
  hosts: k3s_server
  become: true
  vars:
    # Definimos la ruta del config de K3s para que Helm lo encuentre
    ansible_env_k3s:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  tasks:
    - name: Instalar Helm (Script oficial)
      shell: |
        curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      args:
        creates: /usr/local/bin/helm

    - name: Añadir repositorio de Helm para NFS
      kubernetes.core.helm_repository:
        name: nfs-subdir-external-provisioner
        repo_url: "https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/"

    - name: Instalar NFS Subdir External Provisioner
      kubernetes.core.helm:
        name: nfs-provisioner
        chart_ref: nfs-subdir-external-provisioner/nfs-subdir-external-provisioner
        release_namespace: kube-system
        # Pasamos el KUBECONFIG explícitamente al módulo de Helm
        kubeconfig: /etc/rancher/k3s/k3s.yaml
        values:
          nfs:
            server: "192.168.10.230"
            path: "/srv/nfs/k3s-data"
          storageClass:
            name: nfs-client
            defaultClass: true
      environment: "{{ ansible_env_k3s }}"