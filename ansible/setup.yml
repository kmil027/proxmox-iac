---
- name: Nivel 3 - Preparación de todos los nodos
  hosts: mis_nodos
  become: true
  tasks:
    - name: Limpiar instalaciones conflictivas de Docker/Containerd
      apt:
        name: [apache2, containerd, docker, docker-engine, docker.io, runc]
        state: absent
        purge: yes

    - name: Instalar Docker y dependencias
      apt:
        name: [docker.io, curl, ca-certificates]
        state: present
        update_cache: yes

    - name: Asegurar que Docker esté iniciado
      systemd:
        name: docker
        enabled: yes
        state: started

- name: Configurar K3s Master (lab-control)
  hosts: k3s_server
  become: true
  tasks:
    - name: Instalar K3s Server
      shell: curl -sfL https://get.k3s.io | sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Obtener el Token del Cluster
      shell: cat /var/lib/rancher/k3s/server/node-token
      register: node_token

- name: Configurar K3s Workers (Proxmox LXC)
  hosts: k3s_agents
  become: true
  vars:
    master_ip: "192.168.10.230"
  tasks:
    - name: Instalar K3s Agent y unir al clúster
      shell: "curl -sfL https://get.k3s.io | K3S_URL=https://{{ master_ip }}:6443 K3S_TOKEN={{ hostvars['nodo_master']['node_token']['stdout'] }} sh -"
      args:
        creates: /etc/rancher/k3s/k3s-agent.env